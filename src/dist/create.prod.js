"use strict";var axios=require("axios"),ora=require("ora"),fs=require("fs"),ncp=require("ncp"),path=require("path"),inquirer=require("inquirer"),_require=require("util"),promisify=_require.promisify,MetalSmith=require("metalsmith"),render=require("consolidate").ejs.render,render=promisify(render),downloadGitRepo=require("download-git-repo"),downloadGitRepo=promisify(downloadGitRepo),_require2=require("../util/constants.js"),downloadDirectory=_require2.downloadDirectory;function getRepositoryList(){var r,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(axios.get("https://api.github.com/orgs/Yong-template/repos"));case 2:return r=e.sent,t=r.data,e.abrupt("return",t);case 5:case"end":return e.stop()}})}var getTagList=function(r){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(axios.get("https://api.github.com/repos/Yong-template/".concat(r,"/tags")));case 2:return t=e.sent,n=t.data,e.abrupt("return",n);case 5:case"end":return e.stop()}})},loading=function(a,o){return function(){var r,t,n=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return(r=ora(o)).start(),e.next=4,regeneratorRuntime.awrap(a.apply(void 0,n));case 4:return t=e.sent,r.succeed(),e.abrupt("return",t);case 7:case"end":return e.stop()}})}},downloadTask=function(r,t){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n="Yong-template/".concat(r),t&&(n+="#".concat(t)),a="".concat(downloadDirectory,"/").concat(r),console.log("dest",a,"url",n),e.next=6,regeneratorRuntime.awrap(downloadGitRepo(n,a));case 6:return e.abrupt("return",a);case 7:case"end":return e.stop()}})};module.exports=function(n){var r,t,a,o,s,i,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(loading(getRepositoryList,"fetching template ...")());case 2:return r=e.sent,e.next=5,regeneratorRuntime.awrap(inquirer.prompt({name:"repo",type:"list",message:"please choice a template to create project !",choices:r.map(function(e){return e.name})}));case 5:return t=e.sent,a=t.repo,e.next=9,regeneratorRuntime.awrap(loading(getTagList,"fetching tags ...")(a));case 9:return o=e.sent,e.next=12,regeneratorRuntime.awrap(inquirer.prompt({name:"tag",type:"list",message:"please choices tags to create project",choices:o.map(function(e){return e.name})}));case 12:return s=e.sent,i=s.tag,e.next=16,regeneratorRuntime.awrap(loading(downloadTask,"download template ...")(a,i));case 16:return c=e.sent,console.log("template",c),console.log("path.resolve(projectName)",path.resolve(n)),e.next=21,regeneratorRuntime.awrap(ncp(c,path.resolve(n)));case 21:if(fs.existsSync(path.join(c,"render.js"))){e.next=26;break}return e.next=24,regeneratorRuntime.awrap(ncp(c,path.resolve(n)));case 24:e.next=28;break;case 26:return e.next=28,regeneratorRuntime.awrap(new Promise(function(r,t){MetalSmith(__dirname).source(c).destination(path.resolve(n)).use(function(r,t,n){var a,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return a=require(path.join(c,"render.js")),e.next=3,regeneratorRuntime.awrap(inquirer.prompt(a));case 3:o=e.sent,s=t.metadata(),Object.assign(s,o),delete r["render.js"],n();case 8:case"end":return e.stop()}})}).use(function(n,e,r){var a=e.metadata();Reflect.ownKeys(n).forEach(function(r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.includes("js")&&!r.includes("json")){e.next=7;break}if((t=n[r].contents.toString()).includes("<%"))return e.next=5,regeneratorRuntime.awrap(render(t,a));e.next=7;break;case 5:t=e.sent,n[r].contents=Buffer.from(t);case 7:case"end":return e.stop()}})}),r()}).build(function(e){(e?t:r)()})}));case 28:case"end":return e.stop()}})};